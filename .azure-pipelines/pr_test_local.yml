# PR Test Template for sonic-mgmt (Local KVM Execution)
#
# Drop-in replacement for pr_test_template.yml that runs KVM tests locally
# on the sonic-build agent pool instead of submitting to Microsoft's Elastictest.
#
# Keeps the smart impacted-area detection logic:
# - Analyzes git diff to determine which test areas are affected by a PR
# - Maps changed folders to specific test scripts per topology
# - Only runs tests for impacted topologies
#
# Key differences from Elastictest-based template:
# - Runs on sonic-build pool (self-hosted sonic-build-01) instead of sonic-ubuntu-1c
# - Executes tests locally via kvmtest.sh / run_tests.sh instead of Elastictest API
# - No dependency on SONiC-Elastictest variable group or managed identity
# - No Kusto-based dynamic instance calculation (single worker per topology)
# - Topology jobs run sequentially (single agent) instead of in parallel
#
# This is a jobs-level template, meant to be referenced as:
#   - template: .azure-pipelines/pr_test_local.yml@sonic-mgmt
#     parameters:
#       ...

parameters:
- name: AGENT_POOL
  type: object
  default:
    name: sonic-build

- name: TIMEOUT_IN_MINUTES_PR_TEST
  type: number
  default: 480

- name: CHECKOUT_SONIC_MGMT
  type: boolean
  default: false

- name: SONIC_MGMT_NAME
  type: string
  default: "sonic-mgmt"

# Keys: "dpu_checker","dualtor_checker","t0-2vlans_checker","t0-sonic_checker","t0_checker","t1-multi-asic_checker","t1_checker","t2_checker"
# Example: {"t0_checker": ["bgp/test_bgp_command.py"], "t1_checker": ["bgp/test_bgp_fact.py"]}
- name: IMPACT_AREA_INFO
  type: object
  default: {}

- name: GLOBAL_PARAMS
  type: object
  default:
    BUILD_REASON: "PullRequest"
    RETRY_TIMES: "2"
    STOP_ON_FAILURE: "True"
    MAX_RUN_TEST_MINUTES: 480

- name: OVERRIDE_PARAMS
  type: object
  default: {}

jobs:
  - job: get_impacted_area
    displayName: "Get impacted area"
    timeoutInMinutes: 20
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - template: impacted_area_testing/get-impacted-area.yml
        parameters:
          BUILD_BRANCH: $(BUILD_BRANCH)
          IMPACT_AREA_INFO: ${{ parameters.IMPACT_AREA_INFO }}

  # ----------------------------------------------------------------
  # t0 topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_t0
    displayName: "impacted-area-kvmtest-t0 (local)"
    dependsOn:
    - get_impacted_area
    condition: contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 't0_checker')
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."t0_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract t0 test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: t0
          SCRIPTS: $(SCRIPTS)
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          COMMON_EXTRA_PARAMS: "--disable_sai_validation "
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}

  # ----------------------------------------------------------------
  # t0-2vlans topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_t0_2vlans
    displayName: "impacted-area-kvmtest-t0-2vlans (local)"
    dependsOn:
    - get_impacted_area
    - local_kvmtest_t0
    condition: and(not(canceled()), contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 't0-2vlans_checker'))
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."t0-2vlans_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract t0-2vlans test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: t0
          SCRIPTS: $(SCRIPTS)
          DEPLOY_MG_EXTRA_PARAMS: "-e vlan_config=two_vlan_a"
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          COMMON_EXTRA_PARAMS: "--disable_sai_validation "
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}

  # ----------------------------------------------------------------
  # t1-lag topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_t1_lag
    displayName: "impacted-area-kvmtest-t1-lag (local)"
    dependsOn:
    - get_impacted_area
    - local_kvmtest_t0_2vlans
    condition: and(not(canceled()), contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 't1_checker'))
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."t1_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract t1 test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: t1-lag
          SCRIPTS: $(SCRIPTS)
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          COMMON_EXTRA_PARAMS: "--disable_sai_validation "
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}

  # ----------------------------------------------------------------
  # dualtor topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_dualtor
    displayName: "impacted-area-kvmtest-dualtor (local)"
    dependsOn:
    - get_impacted_area
    - local_kvmtest_t1_lag
    condition: and(not(canceled()), contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 'dualtor_checker'))
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."dualtor_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract dualtor test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: dualtor
          SCRIPTS: $(SCRIPTS)
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          COMMON_EXTRA_PARAMS: "--disable_loganalyzer --disable_sai_validation "
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}

  # ----------------------------------------------------------------
  # t0-sonic topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_t0_sonic
    displayName: "impacted-area-kvmtest-t0-sonic (local)"
    dependsOn:
    - get_impacted_area
    - local_kvmtest_dualtor
    condition: and(not(canceled()), contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 't0-sonic_checker'))
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."t0-sonic_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract t0-sonic test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: t0-64-32
          SCRIPTS: $(SCRIPTS)
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          VM_TYPE: vsonic
          COMMON_EXTRA_PARAMS: "--neighbor_type=sonic --disable_sai_validation "
          SPECIFIC_PARAM: '[
              {"name": "bgp/test_bgp_fact.py", "param": "--neighbor_type=sonic --enable_macsec --macsec_profile=128_SCI,256_XPN_SCI"},
              {"name": "macsec", "param": "--neighbor_type=sonic --enable_macsec --macsec_profile=128_SCI,256_XPN_SCI"}
            ]'
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}

  # ----------------------------------------------------------------
  # multi-asic t1 topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_multi_asic_t1
    displayName: "impacted-area-kvmtest-multi-asic-t1 (local)"
    dependsOn:
    - get_impacted_area
    - local_kvmtest_t0_sonic
    condition: and(not(canceled()), contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 't1_checker'))
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."t1_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract multi-asic t1 test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: t1-8-lag
          SCRIPTS: $(SCRIPTS)
          NUM_ASIC: 4
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          COMMON_EXTRA_PARAMS: "--disable_sai_validation "
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}

  # ----------------------------------------------------------------
  # t2 topology tests
  # ----------------------------------------------------------------
  - job: local_kvmtest_t2
    displayName: "impacted-area-kvmtest-t2 (local)"
    dependsOn:
    - get_impacted_area
    - local_kvmtest_multi_asic_t1
    condition: and(not(canceled()), contains(dependencies.get_impacted_area.outputs['SetVariableTask.PR_CHECKERS'], 't2_checker'))
    variables:
      TEST_SCRIPTS: $[ dependencies.get_impacted_area.outputs['SetVariableTask.TEST_SCRIPTS'] ]
    timeoutInMinutes: ${{ parameters.TIMEOUT_IN_MINUTES_PR_TEST }}
    continueOnError: false
    pool: ${{ parameters.AGENT_POOL }}
    steps:
      - ${{ if eq(parameters.CHECKOUT_SONIC_MGMT, true) }}:
        - checkout: ${{ parameters.SONIC_MGMT_NAME }}
          displayName: "Checkout sonic-mgmt repository"

      - script: |
          set -x
          echo "$TEST_SCRIPTS" > /tmp/ts.json
          SCRIPTS=$(jq -r -c '."t2_checker"' /tmp/ts.json | jq -r '. | join(",")')
          rm /tmp/ts.json
          echo "##vso[task.setvariable variable=SCRIPTS]$SCRIPTS"
        displayName: "Extract t2 test scripts"

      - template: run-test-local-template.yml
        parameters:
          TOPOLOGY: t2
          SCRIPTS: $(SCRIPTS)
          STOP_ON_FAILURE: ${{ coalesce(parameters.GLOBAL_PARAMS.STOP_ON_FAILURE, 'True') }}
          RETRY_TIMES: ${{ coalesce(parameters.GLOBAL_PARAMS.RETRY_TIMES, '2') }}
          MGMT_BRANCH: $(BUILD_BRANCH)
          COMMON_EXTRA_PARAMS: "--disable_sai_validation "
          MAX_RUN_TEST_MINUTES: ${{ coalesce(parameters.GLOBAL_PARAMS.MAX_RUN_TEST_MINUTES, 480) }}
